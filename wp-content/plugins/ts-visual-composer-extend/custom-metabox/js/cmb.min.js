window.CMB=function(e,t,c){"use strict";var i=e.cmb_l10,_=e.setTimeout,a={formfield:"",idNumber:!1,file_frames:{},repeatEls:'input:not([type="button"]),select,textarea,.cmb_media_status',defaults:{timePicker:i.defaults.time_picker,datePicker:i.defaults.date_picker,colorPicker:i.defaults.color_picker||{}}};return a.metabox=function(){return a.$metabox?a.$metabox:(a.$metabox=c("table.cmb_metabox"),a.$metabox)},a.init=function(){var t=a.metabox(),s=t.find(".repeatable-group");i.new_admin_style&&t.find(".cmb-spinner img").hide(),a.initPickers(t.find("input:text.cmb_timepicker"),t.find("input:text.cmb_datepicker"),t.find("input:text.cmb_colorpicker")),c("#ui-datepicker-div").wrap('<div class="cmb_element" />'),c('<p><span class="button cmb-multicheck-toggle">'+i.check_toggle+"</span></p>").insertBefore("ul.cmb_checkbox_list"),a.makeListSortable(),t.on("change",".cmb_upload_file",function(){a.formfield=c(this).attr("id"),c("#"+a.formfield+"_id").val("").trigger("change")}).on("click",".cmb-multicheck-toggle",a.toggleCheckBoxes).on("click",".cmb_upload_button",a.handleMedia).on("click",".cmb_remove_file_button",a.handleRemoveMedia).on("click",".add-group-row",a.addGroupRow).on("click",".add-row-button",a.addAjaxRow).on("click",".remove-group-row",a.removeGroupRow).on("click",".remove-row-button",a.removeAjaxRow).on("keyup paste focusout",".cmb_oembed",a.maybeOembed).on("cmb_remove_row",".repeatable-group",a.resetTitlesAndIterator),s.length&&s.filter(".sortable").each(function(){c(this).find(".remove-group-row").before('<a class="shift-rows move-up alignleft" href="#">'+i.up_arrow+'</a> <a class="shift-rows move-down alignleft" href="#">'+i.down_arrow+"</a>")}).on("click",".shift-rows",a.shiftRows).on("cmb_add_row",a.emptyValue),_(a.resizeoEmbeds,500),c(e).on("resize",a.resizeoEmbeds)},a.resetTitlesAndIterator=function(){c(".repeatable-group").each(function(){var e=c(this);e.find(".repeatable-grouping").each(function(t){var i=c(this);i.data("iterator",t),i.find(".cmb-group-title h4").text(e.find(".add-group-row").data("grouptitle").replace("{#}",t+1))})})},a.toggleCheckBoxes=function(e){e.preventDefault();var t=c(this),i=t.parents("td").find("input[type=checkbox]");t.data("checked")?(i.prop("checked",!1),t.data("checked",!1)):(i.prop("checked",!0),t.data("checked",!0))},a.handleMedia=function(e){if(wp){e.preventDefault();var t=a.metabox(),_=c(this);a.formfield=_.prev("input").attr("id");var s=c("#"+a.formfield),n=s.attr("name"),o=!0,d=!0,l=_.hasClass("cmb_upload_list");if(a.formfield in a.file_frames)return a.file_frames[a.formfield].open(),void 0;a.file_frames[a.formfield]=wp.media.frames.file_frame=wp.media({title:t.find("label[for="+a.formfield+"]").text(),button:{text:i.upload_file},multiple:l?!0:!1});var r={list:function(e){d=e.toJSON(),s.val(d.url),c("#"+a.formfield+"_id").val(d.id);var t=[];c(d).each(function(){o=this.type&&"image"===this.type?'<li class="img_status"><img width="50" height="50" src="'+this.url+'" class="attachment-50x50" alt="'+this.filename+'">'+'<p><a href="#" class="cmb_remove_file_button" rel="'+a.formfield+"["+this.id+']">'+i.remove_image+"</a></p>"+'<input type="hidden" id="filelist-'+this.id+'" name="'+n+"["+this.id+']" value="'+this.url+'">'+"</li>":"<li>"+i.file+" <strong>"+this.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+i.download+'</a> / <a href="#" class="cmb_remove_file_button" rel="'+a.formfield+"["+this.id+']">'+i.remove_file+"</a>)"+'<input type="hidden" id="filelist-'+this.id+'" name="'+n+"["+this.id+']" value="'+this.url+'">'+"</li>",t.push(o)}),c(t).each(function(){s.siblings(".cmb_media_status").slideDown().append(this)})},single:function(e){d=e.first().toJSON(),s.val(d.url).trigger("change"),c("#"+a.formfield+"_id").val(d.id).trigger("change"),o=d.type&&"image"===d.type?'<div class="img_status"><img style="max-width: 350px; width: 100%; height: auto;" src="'+d.url+'" alt="'+d.filename+'" title="'+d.filename+'" /><p><a href="#" class="cmb_remove_file_button" rel="'+a.formfield+'">'+i.remove_image+"</a></p></div>":i.file+" <strong>"+d.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+d.url+'" target="_blank" rel="external">'+i.download+'</a> / <a href="#" class="cmb_remove_file_button" rel="'+a.formfield+'">'+i.remove_file+"</a>)",s.siblings(".cmb_media_status").slideDown().html(o)}};a.file_frames[a.formfield].on("select",function(){var e=a.file_frames[a.formfield].state().get("selection"),t=l?"list":"single";r[t](e)}),a.file_frames[a.formfield].open()}},a.handleRemoveMedia=function(e){e.preventDefault();var t=c(this);if(t.is(".attach_list .cmb_remove_file_button"))return t.parents("li").remove(),!1;a.formfield=t.attr("rel");var i=t.parents(".img_status");return a.metabox().find("input#"+a.formfield).val("").trigger("change"),a.metabox().find("input#"+a.formfield+"_id").val("").trigger("change"),i.length?i.html(""):t.parents(".cmb_media_status").html(""),!1},c.fn.replaceText=function(e,t,i){return this.each(function(){var _,a,s=this.firstChild,n=[];if(s)do 3===s.nodeType&&(_=s.nodeValue,a=_.replace(e,t),a!==_&&(!i&&/</.test(a)?(c(s).before(a),n.push(s)):s.nodeValue=a));while(s=s.nextSibling);n.length&&c(n).remove()})},c.fn.cleanRow=function(e,t){var i=c(this),_=i.find('input:not([type="button"]), select, textarea, label');return t&&i.find(".cmb-repeat-table .repeat-row:not(:first-child)").remove(),a.$focus=!1,a.neweditor_id=[],_.filter(":checked").removeAttr("checked"),_.filter(":selected").removeAttr("selected"),i.find(".cmb-group-title").length&&i.find(".cmb-group-title h4").text(i.data("title").replace("{#}",a.idNumber+1)),_.each(function(){var t,i,_=c(this),s=_.hasClass("wp-editor-area"),n=_.attr("for"),o={};if(n)o={"for":n.replace("_"+e,"_"+a.idNumber)};else{var d=_.attr("name"),l=d?d.replace("["+e+"]","["+a.idNumber+"]"):"";i=_.attr("id"),t=i?i.replace("_"+e,"_"+a.idNumber):"",o={id:t,name:l,"data-iterator":a.idNumber}}if(_.removeClass("hasDatepicker").attr(o).val(""),s){t=t?i.replace("zx"+e,"zx"+a.idNumber):"",_.html("");var r=_.parents(".cmb-type-wysiwyg");r.find(".mce-tinymce:not(:first-child)").remove();var m=r.html().replace(new RegExp(i,"g"),t);r.html(m),a.neweditor_id.push({id:t,old:i})}a.$focus=a.$focus?a.$focus:_}),this},c.fn.newRowHousekeeping=function(){var e=c(this),t=e.find(".wp-picker-container"),i=e.find(".cmb_media_status");return t.length&&t.each(function(){var e=c(this).parent();e.html(e.find("input:text.cmb_colorpicker").attr("style",""))}),i.length&&i.empty(),this},a.afterRowInsert=function(e){a.$focus&&a.$focus.focus();var t;if(a.neweditor_id.length){var c;for(c=a.neweditor_id.length-1;c>=0;c--){var i=a.neweditor_id[c].id,_=a.neweditor_id[c].old;if("undefined"==typeof tinyMCEPreInit.mceInit[i]){var s=jQuery.extend({},tinyMCEPreInit.mceInit[_]);for(t in s)"string"==typeof s[t]&&(s[t]=s[t].replace(new RegExp(_,"g"),i));tinyMCEPreInit.mceInit[i]=s}if("undefined"==typeof tinyMCEPreInit.qtInit[i]){var n=jQuery.extend({},tinyMCEPreInit.qtInit[_]);for(t in n)"string"==typeof n[t]&&(n[t]=n[t].replace(new RegExp(_,"g"),i));tinyMCEPreInit.qtInit[i]=n}tinyMCE.init({id:tinyMCEPreInit.mceInit[i]})}}a.initPickers(e.find("input:text.cmb_timepicker"),e.find("input:text.cmb_datepicker"),e.find("input:text.cmb_colorpicker"))},a.updateNameAttr=function(){var e=c(this),t=e.attr("name");if("undefined"==typeof t)return!1;var i=parseInt(e.parents(".repeatable-grouping").data("iterator")),_=i-1,a=t.replace("["+i+"]","["+_+"]");e.attr("name",a)},a.emptyValue=function(e,t){c('input:not([type="button"]), textarea',t).val("")},a.addGroupRow=function(e){e.preventDefault();var t=c(this),i=c("#"+t.data("selector")),_=i.find(".repeatable-grouping").last(),s=parseInt(_.data("iterator"));a.idNumber=s+1;var n=_.clone();n.data("title",t.data("grouptitle")).newRowHousekeeping().cleanRow(s,!0);var o=c('<tr class="repeatable-grouping" data-iterator="'+a.idNumber+'">'+n.html()+"</tr>");_.after(o),a.afterRowInsert(o),i.find(".repeatable-grouping").length<=1?i.find(".remove-group-row").prop("disabled",!0):i.find(".remove-group-row").removeAttr("disabled"),i.trigger("cmb_add_row",o)},a.addAjaxRow=function(e){e.preventDefault();var t=c(this),i="#"+t.data("selector"),_=c(i),s=_.find(".empty-row"),n=parseInt(s.find("[data-iterator]").data("iterator"));a.idNumber=n+1;var o=s.clone();o.newRowHousekeeping().cleanRow(n),s.removeClass("empty-row hidden").addClass("repeat-row"),s.after(o),a.afterRowInsert(o),_.trigger("cmb_add_row",o)},a.removeGroupRow=function(e){e.preventDefault();var t=c(this),i=c("#"+t.data("selector")),_=t.parents(".repeatable-grouping"),s=i.find(".repeatable-grouping").length;_.nextAll(".repeatable-grouping").find(a.repeatEls).each(a.updateNameAttr),s>1&&(_.remove(),3>s?i.find(".remove-group-row").prop("disabled",!0):i.find(".remove-group-row").prop("disabled",!1),i.trigger("cmb_remove_row"))},a.removeAjaxRow=function(e){e.preventDefault();var t=c(this),i=t.parents("tr"),_=t.parents(".cmb-repeat-table");_.find("tr").length>2&&(i.hasClass("empty-row")&&i.prev().addClass("empty-row").removeClass("repeat-row"),t.parents(".cmb-repeat-table tr").remove(),_.trigger("cmb_remove_row"))},a.shiftRows=function(e){e.preventDefault();var t=c(this),i=t.parents(".repeatable-grouping"),_=t.hasClass("move-up")?i.prev(".repeatable-grouping"):i.next(".repeatable-grouping");if(_.length){var s=[];i.find(a.repeatEls).each(function(){var e,t=c(this);t.hasClass("cmb_media_status")?e=t.html():"checkbox"===t.attr("type")?(e=t.is(":checked"),a.log("checked",e)):"select"===t.prop("tagName")?(e=t.is(":selected"),a.log("checked",e)):e=t.val(),s.push({val:e,$:t})}),_.find(a.repeatEls).each(function(e){var t,i=c(this);i.hasClass("cmb_media_status")?(t=i.html(),i.html(s[e].val),s[e].$.html(t)):"checkbox"===i.attr("type")?(s[e].$.prop("checked",i.is(":checked")),i.prop("checked",s[e].val)):"select"===i.prop("tagName")?(s[e].$.prop("selected",i.is(":selected")),i.prop("selected",s[e].val)):(s[e].$.val(i.val()),i.val(s[e].val))})}},a.initPickers=function(e,t,c){a.initTimePickers(e),a.initDatePickers(t),a.initColorPickers(c)},a.initTimePickers=function(e){e.length&&e.timePicker(a.defaults.timePicker)},a.initDatePickers=function(e){e.length&&(e.datepicker("destroy"),e.datepicker(),a.defaults.datePicker&&!c.isEmptyObject(a.defaults.datePicker)&&c.datepicker.setDefaults(a.defaults.datePicker))},a.initColorPickers=function(e){e.length&&("object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker?e.wpColorPicker(a.defaults.colorPicker):e.each(function(e){c(this).after('<div id="picker-'+e+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>'),c("#picker-"+e).hide().farbtastic(c(this))}).focus(function(){c(this).next().show()}).blur(function(){c(this).next().hide()}))},a.makeListSortable=function(){a.metabox().find(".cmb_media_status.attach_list").sortable({cursor:"move"}).disableSelection()},a.maybeOembed=function(e){var t=c(this),i=e.type,s={focusout:function(){_(function(){a.spinner(".postbox table.cmb_metabox",!0)},2e3)},keyup:function(){var c=function(t,c){return e.which<=c&&e.which>=t};(c(48,90)||c(96,111)||c(8,9)||187===e.which||190===e.which)&&a.doAjax(t,e)},paste:function(){_(function(){a.doAjax(t)},100)}};s[i]()},a.resizeoEmbeds=function(){a.metabox().each(function(){var e=c(this),t=e.parents(".inside");if(!t.length)return!0;var i=Math.round(.97*.82*t.width())-30;if(i>639)return!0;var _=e.find(".cmb-type-oembed .embed_status"),a=_.children().not(".cmb_remove_wrapper");return a.length?(a.each(function(){var e=c(this),t=e.width(),_=e.height(),a=i;e.parents(".repeat-row").length&&(a=i-91);var s=Math.round(a*_/t);e.width(a).height(s)}),void 0):!0})},a.log=function(){i.script_debug&&console&&"function"==typeof console.log&&console.log.apply(console,arguments)},a.spinner=function(e,t){t?c(".cmb-spinner",e).hide():c(".cmb-spinner",e).show()},a.doAjax=function(e){var t=e.val();if(!(t.length<6)){var s=e.attr("id"),n=e.parents(".cmb-repeat-table  tr td");n=n.length?n:e.parents(".cmb_metabox tr td");var o=c(".embed_status",n),d=e.width(),l=c(":first-child",o);a.log("oembed_url",t,s),d=o.length&&l.length?l.width():e.width(),a.spinner(n),c(".embed_wrap",n).html(""),_(function(){c(".cmb_oembed:focus").val()===t&&c.ajax({type:"post",dataType:"json",url:i.ajaxurl,data:{action:"cmb_oembed_handler",oembed_url:t,oembed_width:d>300?d:300,field_id:s,object_id:e.data("objectid"),object_type:e.data("objecttype"),cmb_ajax_nonce:i.ajax_nonce},success:function(e){a.log(e),"undefined"!=typeof e.id&&(a.spinner(n,!0),c(".embed_wrap",n).html(e.result))}})},500)}},c(t).ready(a.init),a}(window,document,jQuery);