!function(e){e.fn.dragsort=function(t){if("destroy"==t)return e(this.selector).trigger("dragsort-uninit"),void 0;var i=e.extend({},e.fn.dragsort.defaults,t),n=[],r=null,o=null;return this.each(function(t,c){e(c).is("table")&&1==e(c).children().size()&&e(c).children().is("tbody")&&(c=e(c).children().get(0));var a={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:c,init:function(){var n=0==e(this.container).children().size()?"li":e(this.container).children(":first").get(0).tagName.toLowerCase();""==i.itemSelector&&(i.itemSelector=n),""==i.dragSelector&&(i.dragSelector=n),""==i.placeHolderTemplate&&(i.placeHolderTemplate="<"+n+">&nbsp;</"+n+">"),e(this.container).attr("data-listidx",t).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var t=n[e(this).attr("data-listidx")];e(t.container).unbind("mousedown",t.grabItem).unbind("dragsort-uninit"),t.styleDragHandlers(!1)},getItems:function(){return e(this.container).children(i.itemSelector)},styleDragHandlers:function(t){this.getItems().map(function(){return e(this).is(i.dragSelector)?this:e(this).find(i.dragSelector).get()}).css("cursor",t?"pointer":"")},grabItem:function(t){if(!(1!=t.which||e(t.target).is(i.dragSelectorExclude)||e(t.target).closest(i.dragSelectorExclude).size()>0||0==e(t.target).closest(i.itemSelector).size())){t.preventDefault();for(var r=t.target;!e(r).is(i.dragSelector);){if(r==this)return;r=r.parentNode}e(r).attr("data-cursor",e(r).css("cursor")),e(r).css("cursor","move");var o=n[e(this).attr("data-listidx")],c=this,a=function(){o.dragStart.call(c,t),e(o.container).unbind("mousemove",a)};e(o.container).mousemove(a).mouseup(function(){e(o.container).unbind("mousemove",a),e(r).css("cursor",e(r).attr("data-cursor"))})}},dragStart:function(t){null!=r&&null!=r.draggedItem&&r.dropItem(),r=n[e(this).attr("data-listidx")],r.draggedItem=e(t.target).closest(i.itemSelector),r.draggedItem.attr("data-origpos",e(this).attr("data-listidx")+"-"+r.getItems().index(r.draggedItem));var o=parseInt(r.draggedItem.css("marginTop")),c=parseInt(r.draggedItem.css("marginLeft"));if(r.offset=r.draggedItem.offset(),r.offset.top=t.pageY-r.offset.top+(isNaN(o)?0:o)-1,r.offset.left=t.pageX-r.offset.left+(isNaN(c)?0:c)-1,!i.dragBetween){var a=0==e(r.container).outerHeight()?Math.max(1,Math.round(.5+r.getItems().size()*r.draggedItem.outerWidth()/e(r.container).outerWidth()))*r.draggedItem.outerHeight():e(r.container).outerHeight();r.offsetLimit=e(r.container).offset(),r.offsetLimit.right=r.offsetLimit.left+e(r.container).outerWidth()-r.draggedItem.outerWidth(),r.offsetLimit.bottom=r.offsetLimit.top+a-r.draggedItem.outerHeight()}var l=r.draggedItem.height(),s=r.draggedItem.width();if("tr"==i.itemSelector?(r.draggedItem.children().each(function(){e(this).width(e(this).width())}),r.placeHolderItem=r.draggedItem.clone().attr("data-placeholder",!0),r.draggedItem.after(r.placeHolderItem),r.placeHolderItem.children().each(function(){e(this).css({borderWidth:0,width:e(this).width()+1,height:e(this).height()+1}).html("&nbsp;")})):(r.draggedItem.after(i.placeHolderTemplate),r.placeHolderItem=r.draggedItem.next().css({height:l,width:s}).attr("data-placeholder",!0).css("background-color","#0072C4")),"td"==i.itemSelector){var y=r.draggedItem.closest("table").get(0);e("<table id='"+y.id+"' style='border-width: 0px;' class='dragSortItem "+y.className+"'><tr></tr></table>").appendTo("body").children().append(r.draggedItem)}var d=r.draggedItem.attr("style");r.draggedItem.attr("data-origstyle",d?d:""),r.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:l,width:s}),r.scroll={moveX:0,moveY:0,maxX:e(document).width()-e(window).width(),maxY:e(document).height()-e(window).height()},r.scroll.scrollY=window.setInterval(function(){if(i.scrollContainer!=window)return e(i.scrollContainer).scrollTop(e(i.scrollContainer).scrollTop()+r.scroll.moveY),void 0;var t=e(i.scrollContainer).scrollTop();(r.scroll.moveY>0&&t<r.scroll.maxY||r.scroll.moveY<0&&t>0)&&(e(i.scrollContainer).scrollTop(t+r.scroll.moveY),r.draggedItem.css("top",r.draggedItem.offset().top+r.scroll.moveY+1))},10),r.scroll.scrollX=window.setInterval(function(){if(i.scrollContainer!=window)return e(i.scrollContainer).scrollLeft(e(i.scrollContainer).scrollLeft()+r.scroll.moveX),void 0;var t=e(i.scrollContainer).scrollLeft();(r.scroll.moveX>0&&t<r.scroll.maxX||r.scroll.moveX<0&&t>0)&&(e(i.scrollContainer).scrollLeft(t+r.scroll.moveX),r.draggedItem.css("left",r.draggedItem.offset().left+r.scroll.moveX+1))},10),e(n).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),r.setPos(t.pageX,t.pageY),e(document).bind("mousemove",r.swapItems),e(document).bind("mouseup",r.dropItem),i.scrollContainer!=window&&e(window).bind("DOMMouseScroll mousewheel",r.wheel)},setPos:function(t,n){var o=n-this.offset.top,c=t-this.offset.left;if(i.dragBetween||(o=Math.min(this.offsetLimit.bottom,Math.max(o,this.offsetLimit.top)),c=Math.min(this.offsetLimit.right,Math.max(c,this.offsetLimit.left))),this.draggedItem.parents().each(function(){if("static"!=e(this).css("position")&&(!e.browser.mozilla||"table"!=e(this).css("display"))){var t=e(this).offset();return o-=t.top,c-=t.left,!1}}),i.scrollContainer==window)n-=e(window).scrollTop(),t-=e(window).scrollLeft(),n=Math.max(0,n-e(window).height()+5)+Math.min(0,n-5),t=Math.max(0,t-e(window).width()+5)+Math.min(0,t-5);else{var a=e(i.scrollContainer),l=a.offset();n=Math.max(0,n-a.height()-l.top)+Math.min(0,n-l.top),t=Math.max(0,t-a.width()-l.left)+Math.min(0,t-l.left)}r.scroll.moveX=0==t?0:t*i.scrollSpeed/Math.abs(t),r.scroll.moveY=0==n?0:n*i.scrollSpeed/Math.abs(n),this.draggedItem.css({top:o,left:c})},wheel:function(t){if((e.browser.safari||e.browser.mozilla)&&r&&i.scrollContainer!=window){var n=e(i.scrollContainer),o=n.offset();if(t.pageX>o.left&&t.pageX<o.left+n.width()&&t.pageY>o.top&&t.pageY<o.top+n.height()){var c=t.detail?5*t.detail:t.wheelDelta/-2;n.scrollTop(n.scrollTop()+c),t.preventDefault()}}},buildPositionTable:function(){var t=[];this.getItems().not([r.draggedItem[0],r.placeHolderItem[0]]).each(function(i){var n=e(this).offset();n.right=n.left+e(this).outerWidth(),n.bottom=n.top+e(this).outerHeight(),n.elm=this,t[i]=n}),this.pos=t},dropItem:function(){if(null!=r.draggedItem){var t=r.draggedItem.attr("data-origstyle");return r.draggedItem.attr("style",t),""==t&&r.draggedItem.removeAttr("style"),r.draggedItem.removeAttr("data-origstyle"),r.styleDragHandlers(!0),r.placeHolderItem.before(r.draggedItem),r.placeHolderItem.remove(),e("[data-droptarget], .dragSortItem").remove(),window.clearInterval(r.scroll.scrollY),window.clearInterval(r.scroll.scrollX),r.draggedItem.attr("data-origpos")!=e(n).index(r)+"-"+r.getItems().index(r.draggedItem)&&i.dragEnd.apply(r.draggedItem),r.draggedItem.removeAttr("data-origpos"),r.draggedItem=null,e(document).unbind("mousemove",r.swapItems),e(document).unbind("mouseup",r.dropItem),i.scrollContainer!=window&&e(window).unbind("DOMMouseScroll mousewheel",r.wheel),!1}},swapItems:function(t){if(null==r.draggedItem)return!1;r.setPos(t.pageX,t.pageY);for(var c=r.findPos(t.pageX,t.pageY),a=r,l=0;-1==c&&i.dragBetween&&l<n.length;l++)c=n[l].findPos(t.pageX,t.pageY),a=n[l];if(-1==c)return!1;var s=function(){return e(a.container).children().not(a.draggedItem)},y=s().not(i.itemSelector).each(function(){this.idx=s().index(this)});return null==o||o.top>r.draggedItem.offset().top||o.left>r.draggedItem.offset().left?e(a.pos[c].elm).before(r.placeHolderItem):e(a.pos[c].elm).after(r.placeHolderItem),y.each(function(){var t=s().eq(this.idx).get(0);this!=t&&s().index(this)<this.idx?e(this).insertAfter(t):this!=t&&e(this).insertBefore(t)}),e(n).each(function(e,t){t.createDropTargets(),t.buildPositionTable()}),o=r.draggedItem.offset(),!1},findPos:function(e,t){for(var i=0;i<this.pos.length;i++)if(this.pos[i].left<e&&this.pos[i].right>e&&this.pos[i].top<t&&this.pos[i].bottom>t)return i;return-1},createDropTargets:function(){i.dragBetween&&e(n).each(function(){var t=e(this.container).find("[data-placeholder]"),n=e(this.container).find("[data-droptarget]");t.size()>0&&n.size()>0?n.remove():0==t.size()&&0==n.size()&&("td"==i.itemSelector?e(i.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):e(this.container).append(r.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),r.placeHolderItem.attr("data-placeholder",!0))})}};a.init(),n.push(a)}),this},e.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}}(jQuery);