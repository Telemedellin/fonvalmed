!function(){var e,t,i,n,s,r,a,o,l,c,u,h,d,p,f,m,g,y,v,b,w,x,T,j,C,_={}.hasOwnProperty,k=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1},Q=[].slice;j=Array.prototype.slice,e=function(e,t){return null==t&&(t=document),"object"==typeof e||"undefined"!=typeof exports&&null!==exports?e:t.querySelector(e)},x=function(){function e(){}return e.uniqid=function(){var e;return e=0,{get:function(){return e++}}}(),e.extend=function(e){var t,i,n,s,r,a;for(i=e,s=j.call(arguments,1),r=0,a=s.length;a>r;r++){t=s[r];for(n in t)_.call(t,n)&&(i[n]=t[n])}return i},e.clampRGB=function(e){return 0>e?0:e>255?255:e},e.copyAttributes=function(e,t,i){var n,s,r,a,o,l;for(null==i&&(i={}),a=e.attributes,l=[],s=0,r=a.length;r>s;s++)n=a[s],null!=i.except&&(o=n.nodeName,k.call(i.except,o)>=0)||l.push(t.setAttribute(n.nodeName,n.nodeValue));return l},e.dataArray=function(e){return null==e&&(e=0),s.NodeJS||null!=window.Uint8Array?new Uint8Array(e):new Array(e)},e}(),"undefined"!=typeof exports&&null!==exports?(b=exports,a=require("canvas"),d=a.Image,c=require("fibers"),T=require("fs")):b=window,b.Caman=s=function(){function i(){var e,n,s,r=this;if(0===arguments.length)throw"Invalid arguments";return this instanceof i?(this.finishInit=this.finishInit.bind(this),this.imageLoaded=this.imageLoaded.bind(this),e=arguments[0],i.NodeJS||(s=parseInt(i.getAttrId(e[0]),10),n="function"==typeof e[1]?e[1]:"function"==typeof e[2]?e[2]:function(){},isNaN(s)||!w.has(s))?(this.id=x.uniqid.get(),this.initializedPixelData=this.originalPixelData=null,this.cropCoordinates={x:0,y:0},this.cropped=!1,this.resized=!1,this.pixelStack=[],this.layerStack=[],this.canvasQueue=[],this.currentLayer=null,this.scaled=!1,this.analyze=new t(this),this.renderer=new v(this),this.domIsLoaded(function(){return r.parseArguments(e),r.setup()}),this):w.execute(s,n)):new i(arguments)}return i.version={release:"4.1.1",date:"4/8/2013"},i.DEBUG=!1,i.NodeJS="undefined"!=typeof exports&&null!==exports,i.autoload=!i.NodeJS,i.allowRevert=!0,i.crossOrigin="anonymous",i.toString=function(){return"Version "+i.version.release+", Released "+i.version.date},i.remoteProxy="",i.proxyParam="camanProxyUrl",i.getAttrId=function(t){return i.NodeJS?!0:("string"==typeof t&&(t=e(t)),null==t||null==t.getAttribute?null:t.getAttribute("data-caman-id"))},i.prototype.domIsLoaded=function(e){var t,n=this;return i.NodeJS?setTimeout(function(){return e.call(n)},0):"complete"===document.readyState?(f.debug("DOM initialized"),setTimeout(function(){return e.call(n)},0)):(t=function(){return"complete"===document.readyState?(f.debug("DOM initialized"),e.call(n)):void 0},document.addEventListener("readystatechange",t,!1))},i.prototype.parseArguments=function(e){var t,i,n,s;if(0===e.length)throw"Invalid arguments given";if(this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=function(){},this.setInitObject(e[0]),1!==e.length){switch(typeof e[1]){case"string":this.imageUrl=e[1];break;case"function":this.callback=e[1]}if(2!==e.length&&(this.callback=e[2],4===e.length)){n=e[4],s=[];for(t in n)_.call(n,t)&&(i=n[t],s.push(this.options[t]=i));return s}}},i.prototype.setInitObject=function(t){if(i.NodeJS)return this.initObj=t,this.initType="node",void 0;if(this.initObj="object"==typeof t?t:e(t),null==this.initObj)throw"Could not find image or canvas for initialization.";return this.initType=this.initObj.nodeName.toLowerCase()},i.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}},i.prototype.initNode=function(){var e=this;return f.debug("Initializing for NodeJS"),this.image=new d,this.image.onload=function(){return f.debug("Image loaded. Width = "+e.imageWidth()+", Height = "+e.imageHeight()),e.canvas=new a(e.imageWidth(),e.imageHeight()),e.finishInit()},this.image.onerror=function(e){throw e},this.image.src=this.initObj},i.prototype.initImage=function(){return this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),x.copyAttributes(this.image,this.canvas,{except:["src"]}),this.image.parentNode.replaceChild(this.canvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()},i.prototype.initCanvas=function(){return this.canvas=this.initObj,this.context=this.canvas.getContext("2d"),null!=this.imageUrl?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()},i.prototype.imageAdjustments=function(){return this.needsHiDPISwap()&&(f.debug(this.image.src,"->",this.hiDPIReplacement()),this.swapped=!0,this.image.src=this.hiDPIReplacement()),h.isRemote(this.image)?(this.image.src=h.proxyUrl(this.image.src),f.debug("Remote image detected, using URL = "+this.image.src)):void 0},i.prototype.waitForImageLoaded=function(){return this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded},i.prototype.isImageLoaded=function(){return this.image.complete?null!=this.image.naturalWidth&&0===this.image.naturalWidth?!1:!0:!1},i.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth},i.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight},i.prototype.imageLoaded=function(){return f.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.swapped?(this.canvas.width=this.imageWidth()/this.hiDPIRatio(),this.canvas.height=this.imageHeight()/this.hiDPIRatio()):(this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight()),this.finishInit()},i.prototype.finishInit=function(){var e,t,n,s,r;if(null==this.context&&(this.context=this.canvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hiDPIAdjustments(),this.hasId()||this.assignId(),null!=this.image&&this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.reloadCanvasData(),i.allowRevert)for(this.initializedPixelData=x.dataArray(this.pixelData.length),this.originalPixelData=x.dataArray(this.pixelData.length),r=this.pixelData,e=n=0,s=r.length;s>n;e=++n)t=r[e],this.initializedPixelData[e]=t,this.originalPixelData[e]=t;return this.dimensions={width:this.canvas.width,height:this.canvas.height},w.put(this.id,this),this.callback.call(this,this),this.callback=function(){}},i.prototype.reloadCanvasData=function(){return this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data},i.prototype.resetOriginalPixelData=function(){var e,t,n,s,r;if(!i.allowRevert)throw"Revert disabled";for(this.originalPixelData=x.dataArray(this.pixelData.length),s=this.pixelData,r=[],t=0,n=s.length;n>t;t++)e=s[t],r.push(this.originalPixelData.push(e));return r},i.prototype.hasId=function(){return null!=i.getAttrId(this.canvas)},i.prototype.assignId=function(){return i.NodeJS||this.canvas.getAttribute("data-caman-id")?void 0:this.canvas.setAttribute("data-caman-id",this.id)},i.prototype.hiDPIDisabled=function(){return null!==this.canvas.getAttribute("data-caman-hidpi-disabled")},i.prototype.hiDPIAdjustments=function(){var e;if(!i.NodeJS&&!this.hiDPIDisabled())return e=this.hiDPIRatio(),1!==e?(f.debug("HiDPI ratio = "+e),this.scaled=!0,this.preScaledWidth=this.canvas.width,this.preScaledHeight=this.canvas.height,this.canvas.width=this.preScaledWidth*e,this.canvas.height=this.preScaledHeight*e,this.canvas.style.width=""+this.preScaledWidth+"px",this.canvas.style.height=""+this.preScaledHeight+"px",this.context.scale(e,e),this.width=this.originalWidth=this.canvas.width,this.height=this.originalHeight=this.canvas.height):void 0},i.prototype.hiDPIRatio=function(){var e,t;return t=window.devicePixelRatio||1,e=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,t/e},i.prototype.hiDPICapable=function(){return null!=window.devicePixelRatio&&1!==window.devicePixelRatio},i.prototype.needsHiDPISwap=function(){return this.hiDPIDisabled()||!this.hiDPICapable()?!1:null!==this.hiDPIReplacement()},i.prototype.hiDPIReplacement=function(){return null==this.image?null:this.image.getAttribute("data-caman-hidpi")},i.prototype.replaceCanvas=function(e){var t;return t=this.canvas,this.canvas=e,this.context=this.canvas.getContext("2d"),t.parentNode.replaceChild(this.canvas,t),this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}},i.prototype.render=function(e){var t=this;return null==e&&(e=function(){}),l.trigger(this,"renderStart"),this.renderer.execute(function(){return t.context.putImageData(t.imageData,0,0),e.call(t)})},i.prototype.revert=function(){var e,t,n,s,r;if(!i.allowRevert)throw"Revert disabled";for(r=this.originalVisiblePixels(),e=n=0,s=r.length;s>n;e=++n)t=r[e],this.pixelData[e]=t;return this.context.putImageData(this.imageData,0,0)},i.prototype.reset=function(){var e,t,i,n,s,r,a,o,l;for(e=document.createElement("canvas"),x.copyAttributes(this.canvas,e),e.width=this.originalWidth,e.height=this.originalHeight,t=e.getContext("2d"),n=t.getImageData(0,0,e.width,e.height),r=n.data,l=this.initializedPixelData,i=a=0,o=l.length;o>a;i=++a)s=l[i],r[i]=s;return t.putImageData(n,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(e)},i.prototype.originalVisiblePixels=function(){var e,t,n,s,r,a,o,l,c,u,h,d,p,f,m,y,v,b,w,x,T;if(!i.allowRevert)throw"Revert disabled";if(u=[],d=this.cropCoordinates.x,s=d+this.width,p=this.cropCoordinates.y,r=p+this.height,this.resized){for(e=document.createElement("canvas"),e.width=this.originalWidth,e.height=this.originalHeight,n=e.getContext("2d"),o=n.getImageData(0,0,e.width,e.height),c=o.data,b=this.originalPixelData,a=m=0,v=b.length;v>m;a=++m)l=b[a],c[a]=l;n.putImageData(o,0,0),h=document.createElement("canvas"),h.width=this.width,h.height=this.height,n=h.getContext("2d"),n.drawImage(e,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height),c=n.getImageData(0,0,this.width,this.height).data,f=this.width}else c=this.originalPixelData,f=this.originalWidth;for(a=y=0,w=c.length;w>y;a=y+=4)t=g.locationToCoordinates(a,f),d<=(x=t.x)&&s>x&&p<=(T=t.y)&&r>T&&u.push(c[a],c[a+1],c[a+2],c[a+3]);return u},i.prototype.process=function(e,t){return this.renderer.add({type:u.Type.Single,name:e,processFn:t}),this},i.prototype.processKernel=function(e,t,i,n){var s,r,a;if(!i)for(i=0,s=r=0,a=t.length;a>=0?a>r:r>a;s=a>=0?++r:--r)i+=t[s];return this.renderer.add({type:u.Type.Kernel,name:e,adjust:t,divisor:i,bias:n||0}),this},i.prototype.processPlugin=function(e,t){return this.renderer.add({type:u.Type.Plugin,plugin:e,args:t}),this},i.prototype.newLayer=function(e){var t;return t=new p(this),this.canvasQueue.push(t),this.renderer.add({type:u.Type.LayerDequeue}),e.call(t),this.renderer.add({type:u.Type.LayerFinished}),this},i.prototype.executeLayer=function(e){return this.pushContext(e)},i.prototype.pushContext=function(e){return this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=e,this.pixelData=e.pixelData},i.prototype.popContext=function(){return this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()},i.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()},i}(),t=function(){function e(e){this.c=e}return e.prototype.calculateLevels=function(){var e,t,i,n,s,r,a;for(t={r:{},g:{},b:{}},e=n=0;255>=n;e=++n)t.r[e]=0,t.g[e]=0,t.b[e]=0;for(e=s=0,a=this.c.pixelData.length;a>s;e=s+=4)t.r[this.c.pixelData[e]]++,t.g[this.c.pixelData[e+1]]++,t.b[this.c.pixelData[e+2]]++;for(i=this.c.pixelData.length/4,e=r=0;255>=r;e=++r)t.r[e]/=i,t.g[e]/=i,t.b[e]/=i;return t},e}(),s.DOMUpdated=function(){var e,t,i,n,s,a;if(t=document.querySelectorAll("img[data-caman]"),t.length>0){for(a=[],n=0,s=t.length;s>n;n++)e=t[n],a.push(i=new r(e,function(){return this.parse(),this.execute()}));return a}},s.autoload&&function(){return"complete"===document.readyState?s.DOMUpdated():document.addEventListener("DOMContentLoaded",s.DOMUpdated,!1)}(),r=function(){function e(e,t){this.dataStr=e.getAttribute("data-caman"),this.caman=s(e,t.bind(this))}var t;return t="(\\w+)\\((.*?)\\)",e.prototype.parse=function(){var e,i,n,s,r,a,o,l,c,u,h,d;if(this.ele=this.caman.canvas,o=new RegExp(t,"g"),l=this.dataStr.match(o),l.length>0){for(o=new RegExp(t),d=[],c=0,u=l.length;u>c;c++){s=l[c],h=s.match(o),a=h[0],i=h[1],e=h[2],r=new Function("return function() {        this."+i+"("+e+");      };");try{n=r(),d.push(n.call(this.caman))}catch(p){d.push(f.debug(p))}}return d}},e.prototype.execute=function(){var e;return e=this.ele,this.caman.render(function(){return e.parentNode.replaceChild(this.toImage(),e)})},e}(),s.Blender=i=function(){function e(){}return e.blenders={},e.register=function(e,t){return this.blenders[e]=t},e.execute=function(e,t,i){return this.blenders[e](t,i)},e}(),s.Calculate=n=function(){function e(){}return e.distance=function(e,t,i,n){return Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2))},e.randomRange=function(e,t,i){var n;return null==i&&(i=!1),n=e+Math.random()*(t-e),i?n.toFixed(i):Math.round(n)},e.luminance=function(e){return.299*e.r+.587*e.g+.114*e.b},e.bezier=function(e,t,i,n,s,r){var a,o,l,c,u,h,d,p,f,m,g,y,v,b,w,x,T,j,C,_,k,Q,S,D,I,M,P;for(w=e[0],C=e[1],x=t[0],_=t[1],T=i[0],k=i[1],j=n[0],Q=n[1],d={},u=parseInt(3*(x-w),10),l=3*(T-x)-u,a=j-w-u-l,h=3*(_-C),c=3*(k-_)-h,o=Q-C-h-c,m=S=0;1e3>S;m=++S)b=m/1e3,p=Math.round(a*Math.pow(b,3)+l*Math.pow(b,2)+u*b+w),f=Math.round(o*Math.pow(b,3)+c*Math.pow(b,2)+h*b+C),s&&s>f?f=s:r&&f>r&&(f=r),d[p]=f;if(d.length<n[0]+1)for(m=D=0,M=n[0];M>=0?M>=D:D>=M;m=M>=0?++D:--D)if(null==d[m]){for(y=[m-1,d[m-1]],g=I=m,P=n[0];P>=m?P>=I:I>=P;g=P>=m?++I:--I)if(null!=d[g]){v=[g,d[g]];break}d[m]=y[1]+(v[1]-y[1])/(v[0]-y[0])*(m-y[0])}return null==d[n[0]]&&(d[n[0]]=d[n[0]-1]),d},e}(),o=function(){function e(){}return e.hexToRGB=function(e){var t,i,n;return"#"===e.charAt(0)&&(e=e.substr(1)),n=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2,2),16),t=parseInt(e.substr(4,2),16),{r:n,g:i,b:t}},e.rgbToHSL=function(e,t,i){var n,s,r,a,o,l;return"object"==typeof e&&(t=e.g,i=e.b,e=e.r),e/=255,t/=255,i/=255,a=Math.max(e,t,i),o=Math.min(e,t,i),r=(a+o)/2,a===o?s=l=0:(n=a-o,l=r>.5?n/(2-a-o):n/(a+o),s=function(){switch(a){case e:return(t-i)/n+(i>t?6:0);case t:return(i-e)/n+2;case i:return(e-t)/n+4}}(),s/=6),{h:s,s:l,l:r}},e.hslToRGB=function(e,t,i){var n,s,r,a,o;return"object"==typeof e&&(t=e.s,i=e.l,e=e.h),0===t?o=s=n=i:(a=.5>i?i*(1+t):i+t-i*t,r=2*i-a,o=this.hueToRGB(r,a,e+1/3),s=this.hueToRGB(r,a,e),n=this.hueToRGB(r,a,e-1/3)),{r:255*o,g:255*s,b:255*n}},e.hueToRGB=function(e,t,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?e+6*(t-e)*i:.5>i?t:2/3>i?e+6*(t-e)*(2/3-i):e},e.rgbToHSV=function(e,t,i){var n,s,r,a,o,l;return e/=255,t/=255,i/=255,r=Math.max(e,t,i),a=Math.min(e,t,i),l=r,n=r-a,o=0===r?0:n/r,r===a?s=0:(s=function(){switch(r){case e:return(t-i)/n+(i>t?6:0);case t:return(i-e)/n+2;case i:return(e-t)/n+4}}(),s/=6),{h:s,s:o,v:l}},e.hsvToRGB=function(e,t,i){var n,s,r,a,o,l,c,u;switch(a=Math.floor(6*e),s=6*e-a,o=i*(1-t),l=i*(1-s*t),u=i*(1-(1-s)*t),a%6){case 0:c=i,r=u,n=o;break;case 1:c=l,r=i,n=o;break;case 2:c=o,r=i,n=u;break;case 3:c=o,r=l,n=i;break;case 4:c=u,r=o,n=i;break;case 5:c=i,r=o,n=l}return{r:255*c,g:255*r,b:255*n}},e.rgbToXYZ=function(e,t,i){var n,s,r;return e/=255,t/=255,i/=255,e>.04045?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,t>.04045?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,i>.04045?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,n=.4124*e+.3576*t+.1805*i,s=.2126*e+.7152*t+.0722*i,r=.0193*e+.1192*t+.9505*i,{x:100*n,y:100*s,z:100*r}},e.xyzToRGB=function(e,t,i){var n,s,r;return e/=100,t/=100,i/=100,r=3.2406*e+-1.5372*t+-.4986*i,s=-.9689*e+1.8758*t+.0415*i,n=.0557*e+-.204*t+1.057*i,r>.0031308?r=1.055*Math.pow(r,.4166666667)-.055:r*=12.92,s>.0031308?s=1.055*Math.pow(s,.4166666667)-.055:s*=12.92,n>.0031308?n=1.055*Math.pow(n,.4166666667)-.055:n*=12.92,{r:255*r,g:255*s,b:255*n}},e.xyzToLab=function(e,t,i){var n,s,r,a,o,l;return"object"==typeof e&&(t=e.y,i=e.z,e=e.x),a=95.047,o=100,l=108.883,e/=a,t/=o,i/=l,e=e>.008856451679?Math.pow(e,.3333333333):7.787037037*e+.1379310345,t=t>.008856451679?Math.pow(t,.3333333333):7.787037037*t+.1379310345,i=i>.008856451679?Math.pow(i,.3333333333):7.787037037*i+.1379310345,r=116*t-16,n=500*(e-t),s=200*(t-i),{l:r,a:n,b:s}},e.labToXYZ=function(e,t,i){var n,s,r;return"object"==typeof e&&(t=e.a,i=e.b,e=e.l),s=(e+16)/116,n=s+t/500,r=s-i/200,n=n>.2068965517?n*n*n:.1284185493*(n-.1379310345),s=s>.2068965517?s*s*s:.1284185493*(s-.1379310345),r=r>.2068965517?r*r*r:.1284185493*(r-.1379310345),{x:95.047*n,y:100*s,z:108.883*r}},e.rgbToLab=function(e,t,i){var n;return"object"==typeof e&&(t=e.g,i=e.b,e=e.r),n=this.rgbToXYZ(e,t,i),this.xyzToLab(n)},e.labToRGB=function(){},e}(),l=function(){function e(){}return e.events={},e.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"],e.trigger=function(e,t,i){var n,s,r,a,o;if(this.events[t]&&this.events[t].length){for(a=this.events[t],o=[],s=0,r=a.length;r>s;s++)n=a[s],null===n.target||e.id===n.target.id?o.push(n.fn.call(e,i)):o.push(void 0);return o}},e.listen=function(e,t,i){var n,s;return"string"==typeof e&&(s=e,n=t,e=null,t=s,i=n),k.call(this.types,t)<0?!1:(this.events[t]||(this.events[t]=[]),this.events[t].push({target:e,fn:i}),!0)},e}(),s.Event=l,s.Filter=u=function(){function e(){}return e.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6},e.register=function(e,t){return s.prototype[e]=t},e}(),s.IO=h=function(){function e(){}return e.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/,e.isRemote=function(e){return null==e?!1:this.corsEnabled(e)?!1:this.isURLRemote(e.src)},e.corsEnabled=function(e){var t;return null!=e.crossOrigin&&("anonymous"===(t=e.crossOrigin.toLowerCase())||"use-credentials"===t)},e.isURLRemote=function(e){var t;return t=e.match(this.domainRegex),t?t[1]!==document.domain:!1},e.remoteCheck=function(e){if(this.isURLRemote(e)){if(s.remoteProxy.length)return s.isURLRemote(s.remoteProxy)?(f.info("Cannot use a remote proxy for loading images."),void 0):""+s.remoteProxy+"?camanProxyUrl="+encodeURIComponent(e);f.info("Attempting to load a remote image without a configured proxy. URL: "+e)}},e.proxyUrl=function(e){return""+s.remoteProxy+"?"+s.proxyParam+"="+encodeURIComponent(e)},e.useProxy=function(e){var t;return t={ruby:"rb",python:"py",perl:"pl",javascript:"js"},e=e.toLowerCase(),null!=t[e]&&(e=t[e]),"proxies/caman_proxy."+e},e}(),s.prototype.save=function(){return"undefined"!=typeof exports&&null!==exports?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)},s.prototype.browserSave=function(e){var t;return null==e&&(e="png"),e=e.toLowerCase(),t=this.toBase64(e).replace("image/"+e,"image/octet-stream"),document.location.href=t},s.prototype.nodeSave=function(e,t){var i;null==t&&(t=!0);try{if(i=T.statSync(e),i.isFile()&&!t)return!1}catch(n){f.debug("Creating output file "+e)}return T.writeFile(e,this.canvas.toBuffer(),function(){return f.debug("Finished writing to "+e)})},s.prototype.toImage=function(e){var t;return t=document.createElement("img"),t.src=this.toBase64(e),t.width=this.dimensions.width,t.height=this.dimensions.height,window.devicePixelRatio&&(t.width/=window.devicePixelRatio,t.height/=window.devicePixelRatio),t},s.prototype.toBase64=function(e){return null==e&&(e="png"),e=e.toLowerCase(),this.canvas.toDataURL("image/"+e)},p=function(){function t(e){this.c=e,this.filter=this.c,this.options={blendingMode:"normal",opacity:1},this.layerID=x.uniqid.get(),this.canvas="undefined"!=typeof exports&&null!==exports?new a:document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return t.prototype.newLayer=function(e){return this.c.newLayer.call(this.c,e)},t.prototype.setBlendingMode=function(e){return this.options.blendingMode=e,this},t.prototype.opacity=function(e){return this.options.opacity=e/100,this},t.prototype.copyParent=function(){var e,t,i,n;for(t=this.c.pixelData,e=i=0,n=this.c.pixelData.length;n>i;e=i+=4)this.pixelData[e]=t[e],this.pixelData[e+1]=t[e+1],this.pixelData[e+2]=t[e+2],this.pixelData[e+3]=t[e+3];return this},t.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)},t.prototype.overlayImage=function(t){return"object"==typeof t?t=t.src:"string"==typeof t&&"#"===t[0]&&(t=e(t).src),t?(this.c.renderer.renderQueue.push({type:u.Type.LoadOverlay,src:t,layer:this}),this):this},t.prototype.applyToParent=function(){var e,t,n,s,r,a,o,l,c;for(n=this.c.pixelStack[this.c.pixelStack.length-1],t=this.c.pixelData,c=[],e=o=0,l=t.length;l>o;e=o+=4)a={r:n[e],g:n[e+1],b:n[e+2],a:n[e+3]},r={r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]},s=i.execute(this.options.blendingMode,r,a),s.r=x.clampRGB(s.r),s.g=x.clampRGB(s.g),s.b=x.clampRGB(s.b),null==s.a&&(s.a=r.a),n[e]=a.r-(a.r-s.r)*this.options.opacity*(s.a/255),n[e+1]=a.g-(a.g-s.g)*this.options.opacity*(s.a/255),c.push(n[e+2]=a.b-(a.b-s.b)*this.options.opacity*(s.a/255));return c},t}(),m=function(){function e(){var e,t,i,n;for(n=["log","info","warn","error"],t=0,i=n.length;i>t;t++)e=n[t],this[e]=function(e){return function(){var t;if(t=1<=arguments.length?Q.call(arguments,0):[],s.DEBUG)try{return console[e].apply(console,t)}catch(i){return console[e](t)}}}(e);this.debug=this.log}return e}(),f=new m,g=function(){function e(e){this.c=e,this.loc=0}return e.coordinatesToLocation=function(e,t,i){return 4*(t*i+e)},e.locationToCoordinates=function(e,t){var i,n;return n=Math.floor(e/(4*t)),i=e%(4*t)/4,{x:i,y:n}},e.prototype.locationXY=function(){var e,t;return t=this.c.dimensions.height-Math.floor(this.loc/(4*this.c.dimensions.width)),e=this.loc%(4*this.c.dimensions.width)/4,{x:e,y:t}},e.prototype.getPixelRelative=function(e,t){var i;return i=this.loc+4*this.c.dimensions.width*-1*t+4*e,i>this.c.pixelData.length||0>i?{r:0,g:0,b:0,a:0}:{r:this.c.pixelData[i],g:this.c.pixelData[i+1],b:this.c.pixelData[i+2],a:this.c.pixelData[i+3]}},e.prototype.putPixelRelative=function(e,t,i){var n;return n=this.loc+4*this.c.dimensions.width*-1*t+4*e,newLoc>this.c.pixelData.length||0>newLoc?void 0:(this.c.pixelData[newLoc]=i.r,this.c.pixelData[newLoc+1]=i.g,this.c.pixelData[newLoc+2]=i.b,this.c.pixelData[newLoc+3]=i.a,!0)},e.prototype.getPixel=function(e,t){var i;return i=this.coordinatesToLocation(e,t,this.width),{r:this.c.pixelData[i],g:this.c.pixelData[i+1],b:this.c.pixelData[i+2],a:this.c.pixelData[i+3]}},e.prototype.putPixel=function(e,t,i){var n;return n=this.coordinatesToLocation(e,t,this.width),this.c.pixelData[n]=i.r,this.c.pixelData[n+1]=i.g,this.c.pixelData[n+2]=i.b,this.c.pixelData[n+3]=i.a},e}(),y=function(){function e(){}return e.plugins={},e.register=function(e,t){return this.plugins[e]=t},e.execute=function(e,t,i){return this.plugins[t].apply(e,i)},e}(),s.Plugin=y,s.Renderer=v=function(){function e(t){var i=this;this.c=t,this.processNext=function(){return e.prototype.processNext.apply(i,arguments)},this.renderQueue=[],this.modPixelData=null}return e.Blocks=s.NodeJS?require("os").cpus().length:4,e.prototype.add=function(e){return null!=e?this.renderQueue.push(e):void 0},e.prototype.processNext=function(){var e;if(0===this.renderQueue.length)return l.trigger(this,"renderFinished"),null!=this.finishedFn&&this.finishedFn.call(this.c),this;switch(this.currentJob=this.renderQueue.shift(),this.currentJob.type){case u.Type.LayerDequeue:return e=this.c.canvasQueue.shift(),this.c.executeLayer(e),this.processNext();case u.Type.LayerFinished:return this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();case u.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case u.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}},e.prototype.execute=function(e){return this.finishedFn=e,this.modPixelData=x.dataArray(this.c.pixelData.length),this.processNext()},e.prototype.eachBlock=function(t){var i,n,r,a,o,l,u,h,d,p,f,m,g=this;for(this.blocksDone=0,h=this.c.pixelData.length,n=Math.floor(h/4/e.Blocks),i=4*n,u=i+4*(h/4%e.Blocks),m=[],l=p=0,f=e.Blocks;f>=0?f>p:p>f;l=f>=0?++p:--p)d=l*i,a=d+(l===e.Blocks-1?u:i),s.NodeJS?(o=c(function(){return t.call(g,l,d,a)}),r=o.run(),m.push(this.blockFinished(r))):m.push(setTimeout(function(e,i,n){return function(){return t.call(g,e,i,n)}}(l,d,a),0));return m},e.prototype.executeFilter=function(){return l.trigger(this.c,"processStart",this.currentJob),this.currentJob.type===u.Type.Single?this.eachBlock(this.renderBlock):this.eachBlock(this.renderKernel)},e.prototype.executePlugin=function(){return f.debug("Executing plugin "+this.currentJob.plugin),y.execute(this.c,this.currentJob.plugin,this.currentJob.args),f.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()},e.prototype.renderBlock=function(t,i,n){var r,a,o,u,h;for(f.debug("Block #"+t+" - Filter: "+this.currentJob.name+", Start: "+i+", End: "+n),l.trigger(this.c,"blockStarted",{blockNum:t,totalBlocks:e.Blocks,startPixel:i,endPixel:n}),r={r:0,g:0,b:0,a:0},o=new g(this.c),a=h=i;n>h;a=h+=4)o.loc=a,r.r=this.c.pixelData[a],r.g=this.c.pixelData[a+1],r.b=this.c.pixelData[a+2],r.a=this.c.pixelData[a+3],u=this.currentJob.processFn.call(o,r),null==u.a&&(u.a=r.a),this.c.pixelData[a]=x.clampRGB(u.r),this.c.pixelData[a+1]=x.clampRGB(u.g),this.c.pixelData[a+2]=x.clampRGB(u.b),this.c.pixelData[a+3]=x.clampRGB(u.a);return s.NodeJS?c.yield(t):this.blockFinished(t)},e.prototype.renderKernel=function(e,t,i){var n,r,a,o,l,u,h,d,p,m,y,v,b,w,T,j,C,_;for(v=this.currentJob.name,a=this.currentJob.bias,u=this.currentJob.divisor,y=this.c.pixelData.length,n=this.currentJob.adjust,r=Math.sqrt(n.length),m=[],f.debug("Rendering kernel - Filter: "+this.currentJob.name),t=Math.max(t,4*this.c.dimensions.width*((r-1)/2)),i=Math.min(i,y-4*this.c.dimensions.width*((r-1)/2)),o=(r-1)/2,w=new g(this.c),h=j=t;i>j;h=j+=4){for(w.loc=h,l=0,d=C=-o;o>=-o?o>=C:C>=o;d=o>=-o?++C:--C)for(p=_=o;-o>=o?-o>=_:_>=-o;p=-o>=o?++_:--_)b=w.getPixelRelative(d,p),m[3*l]=b.r,m[3*l+1]=b.g,m[3*l+2]=b.b,l++;T=this.processKernel(n,m,u,a),this.modPixelData[h]=x.clampRGB(T.r),this.modPixelData[h+1]=x.clampRGB(T.g),this.modPixelData[h+2]=x.clampRGB(T.b),this.modPixelData[h+3]=this.c.pixelData[h+3]}return s.NodeJS?c.yield(e):this.blockFinished(e)},e.prototype.blockFinished=function(t){var i,n,s;if(t>=0&&f.debug("Block #"+t+" finished! Filter: "+this.currentJob.name),this.blocksDone++,l.trigger(this.c,"blockFinished",{blockNum:t,blocksFinished:this.blocksDone,totalBlocks:e.Blocks}),this.blocksDone===e.Blocks){if(this.currentJob.type===u.Type.Kernel)for(i=n=0,s=this.c.pixelData.length;s>=0?s>n:n>s;i=s>=0?++n:--n)this.c.pixelData[i]=this.modPixelData[i];return t>=0&&f.debug("Filter "+this.currentJob.name+" finished!"),l.trigger(this.c,"processComplete",this.currentJob),this.processNext()}},e.prototype.processKernel=function(e,t,i,n){var s,r,a,o;for(r={r:0,g:0,b:0},s=a=0,o=e.length;o>=0?o>a:a>o;s=o>=0?++a:--a)r.r+=e[s]*t[3*s],r.g+=e[s]*t[3*s+1],r.b+=e[s]*t[3*s+2];return r.r=r.r/i+n,r.g=r.g/i+n,r.b=r.b/i+n,r},e.prototype.loadOverlay=function(e,t){var i,n,s=this;return i=document.createElement("img"),i.onload=function(){return e.context.drawImage(i,0,0,s.c.dimensions.width,s.c.dimensions.height),e.imageData=e.context.getImageData(0,0,s.c.dimensions.width,s.c.dimensions.height),e.pixelData=e.imageData.data,s.c.pixelData=e.pixelData,s.processNext()},n=h.remoteCheck(t),i.src=null!=n?n:t},e}(),s.Store=w=function(){function e(){}return e.items={},e.has=function(e){return null!=this.items[e]},e.get=function(e){return this.items[e]},e.put=function(e,t){return this.items[e]=t},e.execute=function(e,t){var i=this;return setTimeout(function(){return t.call(i.get(e),i.get(e))},0),this.get(e)},e.flush=function(e){return null==e&&(e=!1),e?delete this.items[e]:this.items={}},e}(),i.register("normal",function(e){return{r:e.r,g:e.g,b:e.b}}),i.register("multiply",function(e,t){return{r:e.r*t.r/255,g:e.g*t.g/255,b:e.b*t.b/255}}),i.register("screen",function(e,t){return{r:255-(255-e.r)*(255-t.r)/255,g:255-(255-e.g)*(255-t.g)/255,b:255-(255-e.b)*(255-t.b)/255}}),i.register("overlay",function(e,t){var i;return i={},i.r=t.r>128?255-2*(255-e.r)*(255-t.r)/255:2*t.r*e.r/255,i.g=t.g>128?255-2*(255-e.g)*(255-t.g)/255:2*t.g*e.g/255,i.b=t.b>128?255-2*(255-e.b)*(255-t.b)/255:2*t.b*e.b/255,i}),i.register("difference",function(e,t){return{r:e.r-t.r,g:e.g-t.g,b:e.b-t.b}}),i.register("addition",function(e,t){return{r:t.r+e.r,g:t.g+e.g,b:t.b+e.b}}),i.register("exclusion",function(e,t){return{r:128-2*(t.r-128)*(e.r-128)/255,g:128-2*(t.g-128)*(e.g-128)/255,b:128-2*(t.b-128)*(e.b-128)/255}}),i.register("softLight",function(e,t){var i;return i={},i.r=t.r>128?255-(255-t.r)*(255-(e.r-128))/255:t.r*(e.r+128)/255,i.g=t.g>128?255-(255-t.g)*(255-(e.g-128))/255:t.g*(e.g+128)/255,i.b=t.b>128?255-(255-t.b)*(255-(e.b-128))/255:t.b*(e.b+128)/255,i}),i.register("lighten",function(e,t){return{r:t.r>e.r?t.r:e.r,g:t.g>e.g?t.g:e.g,b:t.b>e.b?t.b:e.b}}),i.register("darken",function(e,t){return{r:t.r>e.r?e.r:t.r,g:t.g>e.g?e.g:t.g,b:t.b>e.b?e.b:t.b}}),u.register("fillColor",function(){var e;return e=1===arguments.length?o.hexToRGB(arguments[0]):{r:arguments[0],g:arguments[1],b:arguments[2]},this.process("fillColor",function(t){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=255,t})}),u.register("brightness",function(e){return e=Math.floor(255*(e/100)),this.process("brightness",function(t){return t.r+=e,t.g+=e,t.b+=e,t})}),u.register("saturation",function(e){return e*=-.01,this.process("saturation",function(t){var i;return i=Math.max(t.r,t.g,t.b),t.r!==i&&(t.r+=(i-t.r)*e),t.g!==i&&(t.g+=(i-t.g)*e),t.b!==i&&(t.b+=(i-t.b)*e),t})}),u.register("vibrance",function(e){return e*=-1,this.process("vibrance",function(t){var i,n,s;return s=Math.max(t.r,t.g,t.b),n=(t.r+t.g+t.b)/3,i=2*Math.abs(s-n)/255*e/100,t.r!==s&&(t.r+=(s-t.r)*i),t.g!==s&&(t.g+=(s-t.g)*i),t.b!==s&&(t.b+=(s-t.b)*i),t})}),u.register("greyscale",function(){return this.process("greyscale",function(e){var t;return t=n.luminance(e),e.r=t,e.g=t,e.b=t,e})}),u.register("contrast",function(e){return e=Math.pow((e+100)/100,2),this.process("contrast",function(t){return t.r/=255,t.r-=.5,t.r*=e,t.r+=.5,t.r*=255,t.g/=255,t.g-=.5,t.g*=e,t.g+=.5,t.g*=255,t.b/=255,t.b-=.5,t.b*=e,t.b+=.5,t.b*=255,t})}),u.register("hue",function(e){return this.process("hue",function(t){var i,n,s;return n=o.rgbToHSV(t.r,t.g,t.b),i=100*n.h,i+=Math.abs(e),i%=100,i/=100,n.h=i,s=o.hsvToRGB(n.h,n.s,n.v),s.a=t.a,s})}),u.register("colorize",function(){var e,t;return 2===arguments.length?(t=o.hexToRGB(arguments[0]),e=arguments[1]):4===arguments.length&&(t={r:arguments[0],g:arguments[1],b:arguments[2]},e=arguments[3]),this.process("colorize",function(i){return i.r-=(i.r-t.r)*(e/100),i.g-=(i.g-t.g)*(e/100),i.b-=(i.b-t.b)*(e/100),i})}),u.register("invert",function(){return this.process("invert",function(e){return e.r=255-e.r,e.g=255-e.g,e.b=255-e.b,e})}),u.register("sepia",function(e){return null==e&&(e=100),e/=100,this.process("sepia",function(t){return t.r=Math.min(255,t.r*(1-.607*e)+t.g*.769*e+t.b*.189*e),t.g=Math.min(255,t.r*.349*e+t.g*(1-.314*e)+t.b*.168*e),t.b=Math.min(255,t.r*.272*e+t.g*.534*e+t.b*(1-.869*e)),t})}),u.register("gamma",function(e){return this.process("gamma",function(t){return t.r=255*Math.pow(t.r/255,e),t.g=255*Math.pow(t.g/255,e),t.b=255*Math.pow(t.b/255,e),t})}),u.register("noise",function(e){return e=2.55*Math.abs(e),this.process("noise",function(t){var i;return i=n.randomRange(-1*e,e),t.r+=i,t.g+=i,t.b+=i,t
})}),u.register("clip",function(e){return e=2.55*Math.abs(e),this.process("clip",function(t){return t.r>255-e?t.r=255:t.r<e&&(t.r=0),t.g>255-e?t.g=255:t.g<e&&(t.g=0),t.b>255-e?t.b=255:t.b<e&&(t.b=0),t})}),u.register("channels",function(e){var t,i;if("object"!=typeof e)return this;for(t in e)_.call(e,t)&&(i=e[t],0!==i?e[t]/=100:delete e[t]);return 0===e.length?this:this.process("channels",function(t){return null!=e.red&&(e.red>0?t.r+=(255-t.r)*e.red:t.r-=t.r*Math.abs(e.red)),null!=e.green&&(e.green>0?t.g+=(255-t.g)*e.green:t.g-=t.g*Math.abs(e.green)),null!=e.blue&&(e.blue>0?t.b+=(255-t.b)*e.blue:t.b-=t.b*Math.abs(e.blue)),t})}),u.register("curves",function(){var e,t,i,s,r,a,o,l,c,u,h,d;if(t=arguments[0],i=2<=arguments.length?Q.call(arguments,1):[],"string"==typeof t&&(t=t.split("")),"v"===t[0]&&(t=["r","g","b"]),i.length<3||i.length>4)throw"Invalid number of arguments to curves filter";if(l=i[0],s=i[1],r=4===i.length?i[2]:i[1],a=i[i.length-1],e=n.bezier(l,s,r,a,0,255),l[0]>0)for(o=c=0,h=l[0];h>=0?h>c:c>h;o=h>=0?++c:--c)e[o]=l[1];if(a[0]<255)for(o=u=d=a[0];255>=d?255>=u:u>=255;o=255>=d?++u:--u)e[o]=a[1];return this.process("curves",function(i){var n,s;for(o=n=0,s=t.length;s>=0?s>n:n>s;o=s>=0?++n:--n)i[t[o]]=e[i[t[o]]];return i})}),u.register("exposure",function(e){var t,i,n;return n=Math.abs(e)/100,t=[0,255*n],i=[255-255*n,255],0>e&&(t=t.reverse(),i=i.reverse()),this.curves("rgb",[0,0],t,i,[255,255])}),s.Plugin.register("crop",function(e,t,i,n){var s,r;return null==i&&(i=0),null==n&&(n=0),"undefined"!=typeof exports&&null!==exports?s=new a(e,t):(s=document.createElement("canvas"),x.copyAttributes(this.canvas,s),s.width=e,s.height=t),r=s.getContext("2d"),r.drawImage(this.canvas,i,n,e,t,0,0,e,t),this.cropCoordinates={x:i,y:n},this.cropped=!0,this.replaceCanvas(s)}),s.Plugin.register("resize",function(e){var t,i;return null==e&&(e=null),null===e||null==e.width&&null==e.height?(f.error("Invalid or missing dimensions given for resize"),void 0):(null==e.width?e.width=this.canvas.width*e.height/this.canvas.height:null==e.height&&(e.height=this.canvas.height*e.width/this.canvas.width),"undefined"!=typeof exports&&null!==exports?t=new a(e.width,e.height):(t=document.createElement("canvas"),x.copyAttributes(this.canvas,t),t.width=e.width,t.height=e.height),i=t.getContext("2d"),i.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,e.width,e.height),this.resized=!0,this.replaceCanvas(t))}),s.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))}),s.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))}),s.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),s.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),s.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),s.Filter.register("motionBlur",function(e){var t;return t=0===e||180===e?[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:e>0&&90>e||e>180&&270>e?[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:90===e||270===e?[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],this.processKernel("Motion Blur",t)}),s.Filter.register("sharpen",function(e){return null==e&&(e=100),e/=100,this.processKernel("Sharpen",[0,-e,0,-e,4*e+1,-e,0,-e,0])}),C={brightness:function(e,t,i){return e.r=e.r-e.r*t*i.strength,e.g=e.g-e.g*t*i.strength,e.b=e.b-e.b*t*i.strength,e},gamma:function(e,t,i){return e.r=255*Math.pow(e.r/255,Math.max(10*t*i.strength,1)),e.g=255*Math.pow(e.g/255,Math.max(10*t*i.strength,1)),e.b=255*Math.pow(e.b/255,Math.max(10*t*i.strength,1)),e},colorize:function(e,t,i){return e.r-=(e.r-i.color.r)*t,e.g-=(e.g-i.color.g)*t,e.b-=(e.b-i.color.b)*t,e}},u.register("vignette",function(e,t){var i,s,r,a;return null==t&&(t=60),"string"==typeof e&&"%"===e.substr(-1)&&(e=this.dimensions.height>this.dimensions.width?this.dimensions.width*(parseInt(e.substr(0,e.length-1),10)/100):this.dimensions.height*(parseInt(e.substr(0,e.length-1),10)/100)),t/=100,s=[this.dimensions.width/2,this.dimensions.height/2],a=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2)),r=a-e,i=n.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(a){var o,l,c;return c=this.locationXY(),o=n.distance(c.x,c.y,s[0],s[1]),o>r&&(l=Math.max(1,i[Math.round(100*((o-r)/e))]/10*t),a.r=255*Math.pow(a.r/255,l),a.g=255*Math.pow(a.g/255,l),a.b=255*Math.pow(a.b/255,l)),a})}),u.register("rectangularVignette",function(e){var t,i,r,a,l,c,u;if(t={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},e=x.extend(t,e),!e.size)return this;if("string"==typeof e.size)r=parseInt(e.size,10)/100,e.size={width:this.dimensions.width*r,height:this.dimensions.height*r};else if("object"==typeof e.size)for(u=["width","height"],l=0,c=u.length;c>l;l++)i=u[l],"string"==typeof e.size[i]&&(e.size[i]=this.dimensions[i]*(parseInt(e.size[i],10)/100));else"number"===e.size&&(a=e.size,e.size={width:a,height:a});return"string"==typeof e.cornerRadius&&(e.cornerRadius=e.size.width/2*(parseInt(e.cornerRadius,10)/100)),e.strength/=100,e.size.width=Math.floor(e.size.width),e.size.height=Math.floor(e.size.height),e.image={width:this.dimensions.width,height:this.dimensions.height},"colorize"===e.method&&"string"==typeof e.color&&(e.color=o.hexToRGB(e.color)),e.coords={left:(this.dimensions.width-e.size.width)/2,right:this.dimensions.width-e.coords.left,bottom:(this.dimensions.height-e.size.height)/2,top:this.dimensions.height-e.coords.bottom},e.corners=[{x:e.coords.left+e.cornerRadius,y:e.coords.top-e.cornerRadius},{x:e.coords.right-e.cornerRadius,y:e.coords.top-e.cornerRadius},{x:e.coords.right-e.cornerRadius,y:e.coords.bottom+e.cornerRadius},{x:e.coords.left+e.cornerRadius,y:e.coords.bottom+e.cornerRadius}],e.maxDist=n.distance(0,0,e.corners[3].x,e.corners[3].y)-e.cornerRadius,this.process("rectangularVignette",function(t){var i,n,r;return n=this.locationXY(),n.x>e.corners[0].x&&n.x<e.corners[1].x&&n.y>e.coords.bottom&&n.y<e.coords.top?t:n.x>e.coords.left&&n.x<e.coords.right&&n.y>e.corners[3].y&&n.y<e.corners[2].y?t:(n.x>e.corners[0].x&&n.x<e.corners[1].x&&n.y>e.coords.top?i=(n.y-e.coords.top)/e.maxDist:n.y>e.corners[2].y&&n.y<e.corners[1].y&&n.x>e.coords.right?i=(n.x-e.coords.right)/e.maxDist:n.x>e.corners[0].x&&n.x<e.corners[1].x&&n.y<e.coords.bottom?i=(e.coords.bottom-n.y)/e.maxDist:n.y>e.corners[2].y&&n.y<e.corners[1].y&&n.x<e.coords.left?i=(e.coords.left-n.x)/e.maxDist:n.x<=e.corners[0].x&&n.y>=e.corners[0].y?(r=s.distance(n.x,n.y,e.corners[0].x,e.corners[0].y),i=(r-e.cornerRadius)/e.maxDist):n.x>=e.corners[1].x&&n.y>=e.corners[1].y?(r=s.distance(n.x,n.y,e.corners[1].x,e.corners[1].y),i=(r-e.cornerRadius)/e.maxDist):n.x>=e.corners[2].x&&n.y<=e.corners[2].y?(r=s.distance(n.x,n.y,e.corners[2].x,e.corners[2].y),i=(r-e.cornerRadius)/e.maxDist):n.x<=e.corners[3].x&&n.y<=e.corners[3].y&&(r=s.distance(n.x,n.y,e.corners[3].x,e.corners[3].y),i=(r-e.cornerRadius)/e.maxDist),0>i?t:C[e.method](t,i,e))})}),function(){var e,t,i,n,r;return n=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],r=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],t=function(e,t,i,n,s,r,o){var l,c,u,h,d,p,f;return l="undefined"!=typeof exports&&null!==exports?new a:document.createElement("canvas"),l.width=e,l.height=t,h=i+.5*Math.cos(s)*r,p=n+.5*Math.sin(s)*r,d=i-.5*Math.cos(s)*r,f=n-.5*Math.sin(s)*r,c=l.getContext("2d"),u=c.createLinearGradient(h,p,d,f),o?(u.addColorStop(0,"white"),u.addColorStop(.5,"black"),u.addColorStop(1,"white")):(u.addColorStop(0,"white"),u.addColorStop(1,"black")),c.fillStyle=u,c.fillRect(0,0,e,t),c.getImageData(0,0,e,t)},i=function(e,t,i,n,s,r){var o,l,c;return o="undefined"!=typeof exports&&null!==exports?new a:document.createElement("canvas"),o.width=e,o.height=t,l=o.getContext("2d"),c=l.createRadialGradient(i,n,s,i,n,r),c.addColorStop(1,"white"),c.addColorStop(0,"black"),l.fillStyle=c,l.fillRect(0,0,e,t),l.getImageData(0,0,e,t)},e=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},s.Plugin.register("compoundBlur",function(t,i,s,a){var o,l,c,u,h,d,p,f,m,g,y,v,b,w,x,T,j,C,_,k,Q,S,D,I,M,P,E,A,O,L,z,R,F,$,q,B,N,H,U,W,V,Y,G,J,K,X,Z,et,tt,it,nt,st,rt,at,ot,lt,ct,ut;for(Y=this.dimensions.width,g=this.dimensions.height,x=this.pixelData,A=t.data,W=Y*g,V=W<<2,D=[],v=tt=0;V>=0?V>tt:tt>V;v=V>=0?++tt:--tt)D[v]=x[v];for(h=0,N=a,a-=1;N-->=0;)if(j=0|i+.5,0!==j){for(j>256&&(j=256),d=j+j+1,U=Y<<2,G=Y-1,y=g-1,O=j+1,H=O*(O+1)/2,B=new e,F=void 0,R=B,v=it=1;d>=1?d>it:it>d;v=d>=1?++it:--it)R=R.next=new e,v===O&&(F=R);for(R.next=B,$=null,q=null,et=X=0,_=n[j],z=r[j],K=nt=0;g>=0?g>nt:nt>g;K=g>=0?++nt:--nt){for(M=p=o=E=m=c=0,P=O*(I=D[X]),f=O*(S=D[X+1]),l=O*(Q=D[X+2]),E+=H*I,m+=H*S,c+=H*Q,R=B,v=st=0;O>=0?O>st:st>O;v=O>=0?++st:--st)R.r=I,R.g=S,R.b=Q,R=R.next;for(v=rt=1;O>=1?O>rt:rt>O;v=O>=1?++rt:--rt)k=X+((v>G?G:v)<<2),E+=(R.r=I=D[k])*(L=O-v),m+=(R.g=S=D[k+1])*L,c+=(R.b=Q=D[k+2])*L,M+=I,p+=S,o+=Q,R=R.next;for($=B,q=F,J=at=0;Y>=0?Y>at:at>Y;J=Y>=0?++at:--at)D[X]=E*_>>z,D[X+1]=m*_>>z,D[X+2]=c*_>>z,E-=P,m-=f,c-=l,P-=$.r,f-=$.g,l-=$.b,k=et+((k=J+O)<G?k:G)<<2,M+=$.r=D[k],p+=$.g=D[k+1],o+=$.b=D[k+2],E+=M,m+=p,c+=o,$=$.next,P+=I=q.r,f+=S=q.g,l+=Q=q.b,M-=I,p-=S,o-=Q,q=q.next,X+=4;et+=Y}for(J=ot=0;Y>=0?Y>ot:ot>Y;J=Y>=0?++ot:--ot){for(p=o=M=m=c=E=0,X=J<<2,P=O*(I=D[X]),f=O*(S=D[X+1]),l=O*(Q=D[X+2]),E+=H*I,m+=H*S,c+=H*Q,R=B,v=lt=0;O>=0?O>lt:lt>O;v=O>=0?++lt:--lt)R.r=I,R.g=S,R.b=Q,R=R.next;for(Z=Y,v=ct=1;O>=1?O>ct:ct>O;v=O>=1?++ct:--ct)X=Z+J<<2,E+=(R.r=I=D[X])*(L=O-v),m+=(R.g=S=D[X+1])*L,c+=(R.b=Q=D[X+2])*L,M+=I,p+=S,o+=Q,R=R.next,y>v&&(Z+=Y);for(X=J,$=B,q=F,K=ut=0;g>=0?g>ut:ut>g;K=g>=0?++ut:--ut)k=X<<2,D[k]=E*_>>z,D[k+1]=m*_>>z,D[k+2]=c*_>>z,E-=P,m-=f,c-=l,P-=$.r,f-=$.g,l-=$.b,k=J+((k=K+O)<y?k:y)*Y<<2,E+=M+=$.r=D[k],m+=p+=$.g=D[k+1],c+=o+=$.b=D[k+2],$=$.next,P+=I=q.r,f+=S=q.g,l+=Q=q.b,M-=I,p-=S,o-=Q,q=q.next,X+=Y}for(i*=s,v=W;--v>-1;)w=v<<2,C=(255&A[w+2])/255*a,T=0|C,T===h?(u=256*(C-(0|C)),b=256-u,x[w]=x[w]*b+D[w]*u>>8,x[w+1]=x[w+1]*b+D[w+1]*u>>8,x[w+2]=x[w+2]*b+D[w+2]*u>>8):T===h+1&&(x[w]=D[w],x[w+1]=D[w+1],x[w+2]=D[w+2]);h++}return this}),s.Filter.register("tiltShift",function(e){var i,n;return i={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3},e=x.extend(i,e),e.angle*=Math.PI/180,n=t(this.dimensions.width,this.dimensions.height,e.center.x,e.center.y,e.angle,e.focusWidth,!0),this.processPlugin("compoundBlur",[n,e.startRadius,e.radiusFactor,e.steps])}),s.Filter.register("radialBlur",function(e){var t,n,s,r;return t={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null},e=x.extend(t,e),e.radius||(e.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width),s=e.radius/2-e.size,r=e.radius/2,n=i(this.dimensions.width,this.dimensions.height,e.center.x,e.center.y,s,r),this.processPlugin("compoundBlur",[n,e.startRadius,e.radiusFactor,e.steps])})}(),s.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])}),s.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])}),s.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])}),s.Filter.register("posterize",function(e){var t,i;return t=256/e,i=255/(e-1),this.process("posterize",function(e){return e.r=Math.floor(Math.floor(e.r/t)*i),e.g=Math.floor(Math.floor(e.g/t)*i),e.b=Math.floor(Math.floor(e.b/t)*i),e})}),s.Filter.register("vintage",function(e){return null==e&&(e=!0),this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87),e?this.vignette("40%",30):void 0}),s.Filter.register("lomo",function(e){return null==e&&(e=!0),this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),e&&this.vignette("50%",60),this.brightness(5)}),s.Filter.register("clarity",function(e){return null==e&&(e=!1),this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),e&&(this.greyscale(),this.contrast(4)),this}),s.Filter.register("sinCity",function(){return this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),s.Filter.register("sunrise",function(){return this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),s.Filter.register("crossProcess",function(){return this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),s.Filter.register("orangePeel",function(){return this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),s.Filter.register("love",function(){return this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),s.Filter.register("grungy",function(){return this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),s.Filter.register("jarques",function(){return this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),s.Filter.register("pinhole",function(){return this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),s.Filter.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),s.Filter.register("glowingSun",function(e){return null==e&&(e=!0),this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8),e?this.vignette("45%",20):void 0}),s.Filter.register("hazyDays",function(){return this.gamma(1.2),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){return this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),s.Filter.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),s.Filter.register("nostalgia",function(){return this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){return this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),s.Filter.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),s.Filter.register("concentrate",function(){return this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),function(){var e,t,i;return t=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],i=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],e=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},s.Plugin.register("stackBlur",function(n){var s,r,a,o,l,c,u,h,d,p,f,m,g,y,v,b,w,x,T,j,C,_,k,Q,S,D,I,M,P,E,A,O,L,z,R,F,$,q,B,N,H,U,W,V,Y;if(!(isNaN(n)||1>n)){for(n|=0,v=this.pixelData,E=this.dimensions.width,h=this.dimensions.height,o=n+n+1,P=E<<2,A=E-1,d=h-1,j=n+1,M=j*(j+1)/2,I=new e,k=I,p=$=1;o>=1?o>$:$>o;p=o>=1?++$:--$)k=k.next=new e,p===j&&(Q=k);for(k.next=I,S=null,D=null,F=z=0,f=t[n],_=i[n],L=q=0;h>=0?h>q:q>h;L=h>=0?++q:--q){for(w=l=s=T=u=a=0,x=j*(b=v[z]),c=j*(y=v[z+1]),r=j*(g=v[z+2]),T+=M*b,u+=M*y,a+=M*g,k=I,p=B=0;j>=0?j>B:B>j;p=j>=0?++B:--B)k.r=b,k.g=y,k.b=g,k=k.next;for(p=N=1;j>=1?j>N:N>j;p=j>=1?++N:--N)m=z+((p>A?A:p)<<2),T+=(k.r=b=v[m])*(C=j-p),u+=(k.g=y=v[m+1])*C,a+=(k.b=g=v[m+2])*C,w+=b,l+=y,s+=g,k=k.next;for(S=I,D=Q,O=H=0;E>=0?E>H:H>E;O=E>=0?++H:--H)v[z]=T*f>>_,v[z+1]=u*f>>_,v[z+2]=a*f>>_,T-=x,u-=c,a-=r,x-=S.r,c-=S.g,r-=S.b,m=F+((m=O+n+1)<A?m:A)<<2,w+=S.r=v[m],l+=S.g=v[m+1],s+=S.b=v[m+2],T+=w,u+=l,a+=s,S=S.next,x+=b=D.r,c+=y=D.g,r+=g=D.b,w-=b,l-=y,s-=g,D=D.next,z+=4;F+=E}for(O=U=0;E>=0?E>U:U>E;O=E>=0?++U:--U){for(l=s=w=u=a=T=0,z=O<<2,x=j*(b=v[z]),c=j*(y=v[z+1]),r=j*(g=v[z+2]),T+=M*b,u+=M*y,a+=M*g,k=I,p=W=0;j>=0?j>W:W>j;p=j>=0?++W:--W)k.r=b,k.g=y,k.b=g,k=k.next;for(R=E,p=V=1;n>=1?n>=V:V>=n;p=n>=1?++V:--V)z=R+O<<2,T+=(k.r=b=v[z])*(C=j-p),u+=(k.g=y=v[z+1])*C,a+=(k.b=g=v[z+2])*C,w+=b,l+=y,s+=g,k=k.next,d>p&&(R+=E);for(z=O,S=I,D=Q,L=Y=0;h>=0?h>Y:Y>h;L=h>=0?++Y:--Y)m=z<<2,v[m]=T*f>>_,v[m+1]=u*f>>_,v[m+2]=a*f>>_,T-=x,u-=c,a-=r,x-=S.r,c-=S.g,r-=S.b,m=O+((m=L+j)<d?m:d)*E<<2,T+=w+=S.r=v[m],u+=l+=S.g=v[m+1],a+=s+=S.b=v[m+2],S=S.next,x+=b=D.r,c+=y=D.g,r+=g=D.b,w-=b,l-=y,s-=g,D=D.next,z+=E}return this}}),s.Filter.register("stackBlur",function(e){return this.processPlugin("stackBlur",[e])})}(),s.Filter.register("threshold",function(e){return this.process("threshold",function(t){var i;return i=.2126*t.r+.7152*t.g+.0722*t.b,e>i?(t.r=0,t.g=0,t.b=0):(t.r=255,t.g=255,t.b=255),t})})}.call(this);